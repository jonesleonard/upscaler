# .github/workflows/deploy.yml

name: Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

# Best Practice: Set default permissions to read-only for security
permissions:
  contents: read
  pull-requests: write
  id-token: write # Required for OIDC authentication with AWS
  security-events: write # Required for security updates

# Best Practice: Cancel in-progress runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Deploy Infrastructure
  # ============================================================================
    deploy-terraform:
        name: Deploy Terraform
        uses: ./.github/workflows/deploy-terraform.yml
        with:
          environment: dev
          terraform_version: "1.14.3"
          working_directory: "./src/terraform"
          tf_var_runpod_max_concurrency: 5
        secrets: inherit
  # ============================================================================
  # Deploy ECR Splitter Image
  # ============================================================================
    deploy-ecr-splitter:
        name: Deploy Splitter ECR Image
        uses: ./.github/workflows/deploy-ecr-image.yml
        needs: deploy-terraform
        with:
          environment: dev
          ecr_repository_name: ${{ needs.deploy-terraform.outputs.ecr_splitter_repository_name }}
          container_name: ${{ needs.deploy-terraform.outputs.ecr_splitter_repository_name }}
          container_path: "./src/containers/splitter"
          job_definition_name: ${{ needs.deploy-terraform.outputs.batch_split_job_definition_name }}
        secrets: inherit
  # ============================================================================
  # Deploy ECR Combiner Image
  # ============================================================================
    deploy-ecr-combiner:
        name: Deploy Combiner ECR Image
        uses: ./.github/workflows/deploy-ecr-image.yml
        needs: deploy-terraform
        with:
          environment: dev
          ecr_repository_name: ${{ needs.deploy-terraform.outputs.ecr_combiner_repository_name }}
          container_name: ${{ needs.deploy-terraform.outputs.ecr_combiner_repository_name }}
          container_path: "./src/containers/combiner"
          job_definition_name: ${{ needs.deploy-terraform.outputs.batch_combine_job_definition_name }}
        secrets: inherit
  # ============================================================================
  # Deploy RunPod Upscaler
  # ============================================================================
    deploy-runpod-upscaler:
        name: Deploy RunPod Upscaler
        uses: ./.github/workflows/deploy-runpod.yml
        with:
          docker_username: ${{ vars.DOCKERHUB_USERNAME }}
          image_name: "seedvr2-upscaler"
          tag: ${{ github.ref_name }}
          seedvr2_repo: "https://github.com/numz/ComfyUI-SeedVR2_VideoUpscaler.git"
          seedvr2_ref: "v2.5.23"
          python_script_version: "3.12"
          runpod_rest_api_base_url: "https://rest.runpod.io/v1"
          # network volume
          network_volume_name: "seedvr2_upscaler_dev"
          network_volume_size: 30
          network_volume_data_center_id: "US-KS-2"
          # template
          template_name: "seedvr2_upscaler_dev"
          template_container_disk: 60
          template_volume_in_gb: 30
          # endpoint
          endpoint_name: "seedvr2_upscaler_dev"
          endpoint_data_center_id: "US-KS-2"
          endpoint_gpu_ids: "NVIDIA A100 80GB PCIe,NVIDIA A100-SXM4-80GB"
          endpoint_workers_min: 0
          endpoint_workers_max: 2
          endpoint_idle_timeout: 5
          endpoint_execution_timeout_ms: 7200000
          endpoint_scaler_type: "QUEUE_DELAY"
          endpoint_scaler_value: 4
        secrets: inherit