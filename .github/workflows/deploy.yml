# .github/workflows/deploy.yml

name: Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main

# Best Practice: Set default permissions to read-only for security
permissions:
  contents: read
  pull-requests: write
  id-token: write # Required for OIDC authentication with AWS
  security-events: write # Required for security updates

# Best Practice: Cancel in-progress runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


jobs:
    deploy-terraform:
        name: Deploy Terraform
        uses: ./.github/workflows/deploy-terraform.yml
        with:
          environment: dev
          terraform_version: "1.14.3"
          working_directory: "./src/terraform"
        secrets: inherit
    deploy-ecr-splitter:
        name: Deploy Splitter ECR Image
        uses: ./.github/workflows/deploy-ecr-image.yml
        needs: deploy-terraform
        with:
          environment: dev
          ecr_repository_name: ${{ needs.deploy-terraform.outputs.ecr_splitter_repository_name }}
          container_name: ${{ needs.deploy-terraform.outputs.ecr_splitter_repository_name }}
          container_path: "./src/containers/splitter"
          job_definition_name: ${{ needs.deploy-terraform.outputs.batch_split_job_definition_name }}
        secrets: inherit
    deploy-runpod-upscaler:
        name: Deploy RunPod Upscaler
        uses: ./.github/workflows/deploy-runpod.yml
        needs: deploy-terraform
        with:
          docker_username: ${{ vars.DOCKERHUB_USERNAME }}
          image_name: 'seedvr2-upscaler'
          tag: ${{ github.ref_name }}
          seedvr2_repo: "https://github.com/numz/ComfyUI-SeedVR2_VideoUpscaler.git"
          seedvr2_ref: "v2.5.23"
        secrets:
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}