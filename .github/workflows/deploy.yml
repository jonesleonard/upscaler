# .github/workflows/deploy.yml

name: Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

# Best Practice: Set default permissions to read-only for security
permissions:
  contents: read
  pull-requests: write
  id-token: write # Required for OIDC authentication with AWS
  security-events: write # Required for security updates

# Best Practice: Cancel in-progress runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Deploy Infrastructure
  # ============================================================================
    deploy-terraform:
        name: Deploy Terraform
        uses: ./.github/workflows/deploy-terraform.yml
        with:
          environment: dev
          terraform_version: "1.14.3"
          working_directory: "./src/terraform"
          tf_var_runpod_max_concurrency: 5
          tf_var_ecs_max_concurrency: 4
          tf_var_use_s5cmd: true
          tf_var_model_s3_bucket: "upscale-videos-seedvr2-dev-us-east-1"
        secrets: inherit
  # ============================================================================
  # Deploy ECR Splitter Image
  # ============================================================================
    deploy-ecr-splitter:
        name: Deploy Splitter ECR Image
        uses: ./.github/workflows/deploy-ecr-image.yml
        needs: deploy-terraform
        with:
          environment: dev
          ecr_repository_name: ${{ needs.deploy-terraform.outputs.ecr_splitter_repository_name }}
          container_name: ${{ needs.deploy-terraform.outputs.ecr_splitter_repository_name }}
          container_path: "./src/containers/splitter"
          job_definition_name: ${{ needs.deploy-terraform.outputs.batch_split_job_definition_name }}
        secrets: inherit
  # ============================================================================
  # Deploy ECR Combiner Image
  # ============================================================================
    deploy-ecr-combiner:
        name: Deploy Combiner ECR Image
        uses: ./.github/workflows/deploy-ecr-image.yml
        needs: deploy-terraform
        with:
          environment: dev
          ecr_repository_name: ${{ needs.deploy-terraform.outputs.ecr_combiner_repository_name }}
          container_name: ${{ needs.deploy-terraform.outputs.ecr_combiner_repository_name }}
          container_path: "./src/containers/combiner"
          job_definition_name: ${{ needs.deploy-terraform.outputs.batch_combine_job_definition_name }}
        secrets: inherit
  