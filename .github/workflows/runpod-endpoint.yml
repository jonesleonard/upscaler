name: Create or Update RunPod Endpoint

on:
  workflow_call:
    inputs:
      endpoint_name:
        description: 'RunPod endpoint name'
        required: true
        type: string
      environment:
        description: 'The environment to deploy to (e.g., dev, prod)'
        required: true
        type: string
      runpod_rest_api_base_url:
        description: 'RunPod REST API base URL'
        required: true
        type: string
      network_volume_id:
        description: 'RunPod network volume ID for persistent model storage'
        required: false
        type: string
        default: ''
      template_id:
        description: 'RunPod template ID to use'
        required: true
        type: string
      data_center_id:
        description: "Data center ID for the endpoint. If using a network volume, ensure the data center matches."
        required: true
        type: string
      gpu_ids:
        description: 'GPU type IDs'
        required: false
        type: string
        default: 'NVIDIA A40'
      workers_min:
        description: 'Minimum number of workers'
        required: false
        type: number
        default: 0
      workers_max:
        description: 'Maximum number of workers'
        required: false
        type: number
        default: 1
      idle_timeout:
        description: 'Idle timeout in seconds'
        required: false
        type: number
        default: 5
      execution_timeout_ms:
        description: 'Execution timeout in milliseconds'
        required: false
        type: number
        default: 600000
      scaler_type:
        description: 'Scaler type'
        required: false
        type: string
        default: 'QUEUE_DELAY'
      scaler_value:
        description: 'Scaler value'
        required: false
        type: number
        default: 4
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.13'
    secrets:
      RUNPOD_API_KEY:
        required: true
    outputs:
      endpoint_id:
        description: 'The ID of the created/updated endpoint'
        value: ${{ jobs.create-update-endpoint.outputs.endpoint_id }}


permissions:
  contents: read

jobs:
  create-update-endpoint:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    outputs:
      endpoint_id: ${{ steps.run.outputs.endpoint_id }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'
          cache-dependency-path: 'src/runpod_mgmt/requirements.txt'
      
      - name: Install dependencies
        run: pip install -r src/runpod_mgmt/requirements.txt
      
      - name: Create or update RunPod endpoint
        id: run
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
        run: |
          echo "Creating/updating RunPod endpoint: ${{ inputs.endpoint_name }}"
          echo "Using template ID: ${{ inputs.template_id }}"
          
          export PYTHONPATH="${GITHUB_WORKSPACE}/src"
          
          # Build args array
          ARGS=(
            --name "${{ inputs.endpoint_name }}"
            --template-id "${{ inputs.template_id }}"
            --gpu-ids "${{ vars.GPU_IDS || inputs.gpu_ids }}"
            --workers-min ${{ vars.WORKERS_MIN || inputs.workers_min }}
            --workers-max ${{ vars.WORKERS_MAX || inputs.workers_max }}
            --idle-timeout ${{ vars.IDLE_TIMEOUT || inputs.idle_timeout }}
            --execution-timeout-ms ${{ vars.EXECUTION_TIMEOUT_MS || inputs.execution_timeout_ms }}
            --scaler-type "${{ vars.SCALER_TYPE || inputs.scaler_type }}"
            --scaler-value ${{ vars.SCALER_VALUE || inputs.scaler_value }}
          )
          
          # Add network volume if specified
          NETWORK_VOLUME_ID="${{ inputs.network_volume_id }}"
          if [[ -n "$NETWORK_VOLUME_ID" ]]; then
            echo "Using network volume: $NETWORK_VOLUME_ID"
            ARGS+=(--network-volume-id "$NETWORK_VOLUME_ID")
          fi
          
          # Add data center IDs if specified
          DATA_CENTER_ID="${{ vars.DATA_CENTER_ID || inputs.data_center_id }}"
          if [[ -n "$DATA_CENTER_ID" ]]; then
            echo "Using data center ID: $DATA_CENTER_ID"
            ARGS+=(--data-center-ids "$DATA_CENTER_ID")
          fi
          
          python -m runpod_mgmt.endpoint.create_endpoint "${ARGS[@]}"
      
      - name: Endpoint creation result
        if: success()
        run: |
          echo "âœ“ RunPod endpoint successfully created/updated"
          echo "Name: ${{ inputs.endpoint_name }}"
          echo "Template ID: ${{ inputs.template_id }}"
          echo "Endpoint ID: ${{ steps.run.outputs.endpoint_id }}"
