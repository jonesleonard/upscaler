# .github/workflows/deploy-ecr-image.yml

name: Build and Deploy ECR Image

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: string
      ecr_repository_name:
        description: "ECR repository name"
        required: true
        type: string
      container_name:
        description: "Name of the container"
        required: true
        type: string
      container_path:
        description: "Path to the container source code"
        required: true
        type: string
      job_definition_name:
        description: "AWS Batch Job Definition Name to update"
        required: true
        type: string
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      ecr_repository_name:
        description: "ECR repository name"
        required: true
        type: string
      container_name:
        description: "Name of the container"
        required: true
        type: string
      container_path:
        description: "Path to the container source code"
        required: true
        type: string
      job_definition_name:
        description: "AWS Batch Job Definition Name to update"
        required: true
        type: string

# Best Practice: Set default permissions to read-only for security
permissions:
  contents: read
  pull-requests: write
  id-token: write # Required for OIDC authentication with AWS
  security-events: write # Required for uploading SARIF results

jobs:
  # ============================================================================
  # Build Container
  # ============================================================================
  build:
    name: Build Container
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.meta.outputs.version }}
    
    steps:
      - name: Echo Inputs
        id: echo-inputs
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "ECR Repository Name: ${{ inputs.ecr_repository_name }}"
          echo "Container Name: ${{ inputs.container_name }}"
          echo "Container Path: ${{ inputs.container_path }}"
  
      - name: Fail if values are missing or empty
        id: validate-inputs
        run: |
          if [ -z "${{ inputs.ecr_repository_name }}" ] || [ -z "${{ inputs.container_name }}" ] || [ -z "${{ inputs.container_path }}" ]; then
            echo "Error: One or more required inputs are missing or empty."
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.container_name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build container image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.container_path }}
          file: ${{ inputs.container_path }}/Dockerfile
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VERSION=${{ steps.meta.outputs.version }}
            GIT_SHA=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save image for push job
        if: github.ref == 'refs/heads/main'
        run: |
          set -euxo pipefail

          # Use the first tag from metadata action (main-sha format)
          IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          docker save "$IMAGE_TAG" | gzip > container-image.tar.gz
          mv container-image.tar.gz ${{ runner.temp }}/container-image.tar.gz

      - name: Upload image artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v6
        with:
          name: container-image-${{ github.sha }}
          path: ${{ runner.temp }}/container-image.tar.gz
          retention-days: 1

      - name: Comment PR with scan results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Container Build & Security Scan ðŸ³ðŸ”’
            
            **Image:** \`${{ inputs.container_name }}:${{ github.sha }}\`
            **Digest:** \`${{ steps.build.outputs.digest }}\`
            
            âœ… Container image built successfully
            âœ… Trivy vulnerability scan completed
            
            Check the "Security" tab for detailed scan results.
            
            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # ============================================================================
  # Push to ECR (Dev Environment)
  # ============================================================================
  push-dev:
    name: Push to ECR (Dev)
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: dev
    
    outputs:
      ecr-image-uri: ${{ steps.push.outputs.image-uri }}
    
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v7
        with:
          name: container-image-${{ github.sha }}
          path: ${{ runner.temp }}

      - name: Load Docker image
        run: |
          docker load -i ${{ runner.temp }}/container-image.tar.gz
          docker images

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-Container-Deploy-Dev

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag and push image to ECR
        id: push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ inputs.ecr_repository_name }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euxo pipefail

          # Get the actual loaded image tag (first tag from metadata action)
          LOADED_TAG=$(echo "${{ needs.build.outputs.image-tag }}" | head -n1)
          
          # Tag with SHA
          docker tag "$LOADED_TAG" $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          # Tag with 'latest'
          docker tag "$LOADED_TAG" $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          # Tag with short SHA
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          docker tag "$LOADED_TAG" $ECR_REGISTRY/$ECR_REPOSITORY:$SHORT_SHA
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$SHORT_SHA
          
          # Output full image URI
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          echo "image-uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "Pushed image: ${IMAGE_URI}"

  # ============================================================================
  # Update Batch Job Definition
  # ============================================================================
  update-batch-job:
    name: Update Batch Job Definition
    needs: push-dev
    runs-on: ubuntu-latest
    environment:
      name: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-Batch-Update-Dev

      - name: Download and modify the job definition
        shell: bash
        run: |
          set -euxo pipefail

          # Download the existing job definition
          aws batch describe-job-definitions \
            --job-definition-name ${{ inputs.job_definition_name }} \
            --status ACTIVE | \
            jq --arg NEW_IMAGE "${{ needs.push-dev.outputs.ecr-image-uri }}" \
              '.jobDefinitions[0] | 
                del(.jobDefinitionArn, .revision, .status, .containerOrchestrationType) | 
                .containerProperties.image = $NEW_IMAGE' > job_definition.json
          
          # debgug output
          echo "Modified Job Definition:"
          cat job_definition.json

      - name: Register the new job definition
        id: register-job
        shell: bash
        run: |
          set -euxo pipefail

          # Register the new job definition with updated image
          aws batch register-job-definition \
            --job-definition-name ${{ inputs.job_definition_name }} \
            --type container \
            --cli-input-json file://job_definition.json

          # Get the new revision number
          NEW_REVISION=$(aws batch describe-job-definitions --job-definition-name ${{ inputs.job_definition_name }} --status ACTIVE | \
            jq -r '.jobDefinitions | unique_by(.revision) | last(.[]).revision')
          echo "new-revision=${NEW_REVISION}" >> $GITHUB_OUTPUT
          echo "Registered new job definition revision: ${NEW_REVISION}"

      - name: Summary
        run: |
          set -euxo pipefail
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Container Image Pushed:** ${{ needs.push-dev.outputs.ecr-image-uri }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Job Definition Updated:** Revision ${{ steps.register-job.outputs.new-revision }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- New Batch jobs will automatically use the updated image" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor CloudWatch Logs for job execution" >> $GITHUB_STEP_SUMMARY
          echo "- Verify functionality with a test job submission" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Optional: Run Integration Test
  # ============================================================================
  # test-integration:
  #   name: Run Integration Test (Optional)
  #   needs: update-batch-job
  #   if: github.ref == 'refs/heads/main' && vars.RUN_INTEGRATION_TESTS == 'true'
  #   runs-on: ubuntu-latest
  #   environment:
  #     name: dev
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Configure AWS Credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
  #         aws-region: ${{ vars.AWS_REGION || env.AWS_REGION }}
  #         role-session-name: GitHubActions-Integration-Test

  #     - name: Upload test video to S3
  #       run: |
  #         # TODO: Upload a small test video to S3
  #         echo "Integration test placeholder - implement test video upload"

  #     - name: Submit test Batch job
  #       id: submit-job
  #       run: |
  #         # TODO: Submit a test job to Batch
  #         echo "Integration test placeholder - implement job submission"

  #     - name: Wait for job completion
  #       run: |
  #         # TODO: Poll job status and wait for completion
  #         echo "Integration test placeholder - implement job monitoring"

  #     - name: Verify outputs
  #       run: |
  #         # TODO: Check that segments and manifest were created correctly
  #         echo "Integration test placeholder - implement output verification"
