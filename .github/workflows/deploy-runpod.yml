name: Deploy RunPod Configuration

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy-runpod.yml'
      - 'src/containers/upscaler_runpod/**'
      - 'src/runpod_mgmt/**'

permissions:
  contents: read

jobs:
  # ============================================================================
  # Docker: Build and Push SeedVR2 Upscaler Image
  # ============================================================================
  build-and-push-seedvr2-image:
    name: Build and Push Docker Image
    uses: ./.github/workflows/docker-build-push.yml
    with:
      dockerhub_username: ${{ vars.DOCKERHUB_USERNAME }}
      image_name: "seedvr2-upscaler"
      build_context: './src/containers/upscaler_runpod'
      dockerfile: './src/containers/upscaler_runpod/Dockerfile'
      tag: ${{ github.ref_name }}
      build_args: |
        SEEDVR2_REPO="https://github.com/numz/ComfyUI-SeedVR2_VideoUpscaler.git"
        SEEDVR2_REF="v2.5.23"
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  # ============================================================================
  # RunPod: Create/Update Template
  # ============================================================================
  create-update-runpod-template:
    name: Create/Update RunPod Template
    needs: build-and-push-seedvr2-image
    uses: ./.github/workflows/runpod-template.yml
    with:
      python_version: "3.12"
      runpod_rest_api_base_url: "https://rest.runpod.io/v1"
      full_image_name: ${{ needs.build-and-push-seedvr2-image.outputs.full_image_name }}
      template_name: "seedvr2_upscaler_dev"
      container_disk: 60
      volume_in_gb: 30
    secrets:
      RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
  
  # ============================================================================
  # RunPod: Create/Update Network Volume
  # ============================================================================
  create-update-runpod-network-volume:
    name: Create/Update RunPod Network Volume
    uses: ./.github/workflows/runpod-network-volume.yml
    with:
      python_version: "3.12"
      runpod_rest_api_base_url: "https://rest.runpod.io/v1"
      network_volume_name: "seedvr2_upscaler_dev"
      data_center_id: "US-KS-2"
      network_volume_size: 30
    secrets:
      RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
  
  # ============================================================================
  # RunPod: Create/Update Endpoint
  # ============================================================================
  create-update-endpoint:
    name: Create/Update RunPod Endpoint
    needs: 
      - create-update-runpod-template
      - create-update-runpod-network-volume
    uses: ./.github/workflows/runpod-endpoint.yml
    with:
      environment: "dev"
      python_version: "3.12"
      runpod_rest_api_base_url: "https://rest.runpod.io/v1"
      endpoint_name: "seedvr2_upscaler_dev"
      network_volume_id: ${{ needs.create-update-runpod-network-volume.outputs.network_volume_id }}
      template_id: ${{ needs.create-update-runpod-template.outputs.template_id }}
      data_center_id: "US-KS-2"
      gpu_ids: "NVIDIA A100 80GB PCIe,NVIDIA A100-SXM4-80GB"
      workers_min: 0
      workers_max: 3
      idle_timeout: 5
      execution_timeout_ms: 86400000
      scaler_type: "QUEUE_DELAY"
      scaler_value: 4
    secrets:
      RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
  
  