name: Build, Push, and Deploy

on:
  workflow_call:
    inputs:
      docker_username:
        description: 'DockerHub username'
        required: true
        type: string
      image_name:
        description: 'Docker image name'
        required: true
        type: string
      tag:
        description: 'Docker image tag (default: latest)'
        required: true
        type: string
      seedvr2_repo:
        description: 'SeedVR2 repository to use'
        required: true
        type: string
      seedvr2_ref:
        description: 'SeedVR2 version to use'
        required: true
        type: string
      python_script_version:
        description: 'Python version to use for RunPod actions'
        required: false
        type: string
        default: '3.12'
      runpod_rest_api_base_url:
        description: 'RunPod REST API base URL'
        required: true
        type: string
      network_volume_name:
        description: 'RunPod network volume name'
        required: false
        type: string
        default: 'seedvr2_upscaler'
      network_volume_size:
        description: 'RunPod network volume size in GB'
        required: false
        type: number
        default: 30
      network_volume_data_center_id:
        description: 'RunPod network volume data center ID'
        required: true
        type: string
      template_name:
        description: 'RunPod template name'
        required: false
        type: string
        default: 'seedvr2_upscaler'
      template_container_disk:
        description: 'RunPod template container disk size in GB'
        required: false
        type: number
        default: 50
    outputs:
      network_volume_id:
        description: "The ID of the created/updated network volume"
        value: ${{ jobs.create-update-runpod-network-volume.outputs.network_volume_id }}
    secrets:
      dockerhub_token:
        description: 'DockerHub access token'
        required: true
      runpod_api_key:
        description: 'RunPod API key'
        required: true


permissions:
  contents: read

jobs:
  # ============================================================================
  # Docker: Build and Push SeedVR2 Upscaler Image
  # ============================================================================
  build-and-push-seedvr2-image:
    name: Build and Push Docker Image
    uses: ./.github/workflows/docker-build-push.yml
    with:
      dockerhub_username: ${{ inputs.docker_username }}
      image_name: ${{ inputs.image_name }}
      build_context: './src/containers/upscaler_runpod'
      dockerfile: './src/containers/upscaler_runpod/Dockerfile'
      tag: ${{ inputs.tag || 'latest' }}
      build_args: |
        SEEDVR2_REPO=${{ inputs.seedvr2_repo  }}
        SEEDVR2_REF=${{ inputs.seedvr2_ref  }}
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  # ============================================================================
  # RunPod: Create/Update Template
  # ============================================================================
  create-update-runpod-template:
    name: Create/Update RunPod Template
    needs: build-and-push-seedvr2-image
    uses: ./.github/workflows/runpod-template.yml
    with:
      python_version: ${{ inputs.python_script_version }}
      runpod_rest_api_base_url: ${{ inputs.runpod_rest_api_base_url }}
      full_image_name: ${{ needs.build-and-push-seedvr2-image.outputs.full_image_name }}
      template_name: ${{ inputs.template_name }}
      container_disk: ${{ inputs.template_container_disk }}
    secrets:
      RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
  
  # ============================================================================
  # RunPod: Create/Update Network Volume
  # ============================================================================
  create-update-runpod-network-volume:
    name: Create/Update RunPod Network Volume
    uses: ./.github/workflows/runpod-network-volume.yml
    with:
      python_version: ${{ inputs.python_script_version }}
      runpod_rest_api_base_url: ${{ inputs.runpod_rest_api_base_url }}
      network_volume_name: ${{ inputs.network_volume_name }}
      data_center_id: ${{ inputs.network_volume_data_center_id }}
      network_volume_size: ${{ inputs.network_volume_size }}
    secrets:
      RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
  
  